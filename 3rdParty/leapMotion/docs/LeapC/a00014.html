<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>Leap Motion C API: Images Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="leapmotion-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Leap Motion C API
   &#160;<span id="projectnumber">3.1</span>
   </div>
   <div id="projectbrief">The API to the LeapC library.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>LeapC</span></a></li>
      <li><a href="modules.html"><span>API&#160;Reference</span></a></li>
      <li class="current"><a href="pages.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('a00014.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Images Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Leap Motion service creates the tracking data provided in a <a class="el" href="a00029.html#a00069" title="A snapshot, or frame of data, containing the tracking data for a single moment in time...">LEAP_TRACKING_EVENT</a> struct by analyzing a set of stereo images taken by the Leap Motion device cameras. The image set used to create a frame of data can be obtained by calling <a class="el" href="a00036.html#gaf157e7c0438fec45851069189735e672" title="Requests an image from the service. ">LeapRequestImages()</a>. LeapC writes the set of stereo images to a buffer that you supply; stacked with the left image on top of the right image. After you call <a class="el" href="a00036.html#gaf157e7c0438fec45851069189735e672" title="Requests an image from the service. ">LeapRequestImages()</a>, LeapC dispatches a LEAP_IMAGE_COMLETE_EVENT message through the usual message pump when the image buffer has been completely written. The message struct also contains the image properties.</p>
<h1><a class="anchor" id="imagesamplec"></a>
ImageSample.c</h1>
<p>The ImageSample.c program uses the callback mechanism defined by <a class="el" href="a00008.html#ExampleConnectionc">ExampleConnection.c</a> described in the other examples. Instead of printing out frame information, though, ImageSample uses the frame information to request the associated set of stereo images.</p>
<p>For simplicity, ImageSample only handles a single image request at a time. The code skips images for any frames until the current pending request is complete. In general, you will receive the image before the next frame; however, if the system becomes overloaded, image completion could slip a few frames behind. The method used in the example would skip the images for the interveaning frames, which might not be acceptable. It is also possible to lose image requests under load. In this case, the example's method would stop drawing frames altogether. Adding a request time-out to correct this pitfall is left as an exercise for the reader.</p>
<p>The buffer size needed for a set of images is determined by the image dimensions, the image bytes-per-pixel, and the number of images in the set. For a typical image from the Leap Motion peripheral device, this size is: </p><pre class="fragment">640 (width) * 240 (height) * 1 (byte-per-pixel) * 2 (images) = 307200 bytes
</pre><p>Other Leap Motion devices, such as the Rigel module, provide images with different resolutions and hence require different buffer sizes. Because of this, you should always determine the required buffer size dynamically, using an image request error callback as illustrated in this example. Whenever a request error occurs &ndash; and allocating a buffer that is too small is an error &ndash; the <a class="el" href="a00029.html#a00060" title="The error struct received from LeapPollConnection() when an image request goes wrong. ">LEAP_IMAGE_FRAME_REQUEST_ERROR_EVENT</a> struct provides the current, required buffer size. You can update the size used to allocate your image buffer with this value and either re-request the image or skip it and do better on the next one.</p>
 <div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;#undef __cplusplus</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;#include &lt;stdio.h&gt;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;#include &lt;stdlib.h&gt;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;#include &quot;LeapC.h&quot;</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;#include &quot;ExampleConnection.h&quot;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;LEAP_CONNECTION *connection;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;//Image request variables</div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;LEAP_IMAGE_FRAME_REQUEST_TOKEN *image_token = 0;</div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;void* image_buffer = NULL;</div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;uint64_t image_size = 1;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;bool imageRequested = false;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;/** Callback for when the connection opens. */</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;void OnConnect(){</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;  printf(&quot;Connected.\n&quot;);</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;}</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;/** Callback for when a device is found. */</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;void OnDevice(const LEAP_DEVICE_INFO *props){</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;  printf(&quot;Found device %s.\n&quot;, props-&gt;serial);</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;}</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;/** Callback for when a frame of tracking data is available. */</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;void OnFrame(const LEAP_TRACKING_EVENT *frame){</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;  printf(&quot;Frame %lli with %i hands.\n&quot;, (long long int)frame-&gt;info.frame_id, frame-&gt;nHands);</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  for(uint32_t h = 0; h &lt; frame-&gt;nHands; h++){</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    LEAP_HAND* hand = &amp;frame-&gt;pHands[h];</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    printf(&quot;    Hand id %i is a %s hand with position (%f, %f, %f).\n&quot;,</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;                hand-&gt;id,</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;                (hand-&gt;type == eLeapHandType_Left ? &quot;left&quot; : &quot;right&quot;),</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;                hand-&gt;palm.position.x,</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;                hand-&gt;palm.position.y,</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;                hand-&gt;palm.position.z);</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  }</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  //Request the matching image (only do this if using images)</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  if(!imageRequested){ //only support one outstanding image request to reduce bookkeeping</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    imageRequested = true;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    LEAP_IMAGE_FRAME_DESCRIPTION frameDescription;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    frameDescription.type = eLeapImageType_Default;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    frameDescription.frame_id = frame-&gt;info.frame_id;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    frameDescription.buffer_len = image_size;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    frameDescription.pBuffer = image_buffer;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    image_token = malloc(sizeof(LEAP_IMAGE_FRAME_REQUEST_TOKEN));</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    eLeapRS result = LeapRequestImages(*connection, &amp;frameDescription, image_token);</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    printf(&quot;LeapRequestImages() result was %s.\n&quot;, ResultString(result));</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  }</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;}</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;/** Callback for when an image request completes. */</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;void OnImages(const LEAP_IMAGE_COMPLETE_EVENT *imageCompleteEvent){</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    printf(&quot;Received image set for frame %lli with size %lli.\n&quot;,</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;           (long long int)imageCompleteEvent-&gt;info.frame_id,</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;           (long long int)imageCompleteEvent-&gt;data_written);</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    free(image_token);</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    image_token = 0;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    imageRequested = false;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;}</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;/** Callback for when an image request fails. */</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;void OnImageError(const LEAP_IMAGE_FRAME_REQUEST_ERROR_EVENT *imageErrorEvent){</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;    if(imageErrorEvent-&gt;error == eLeapImageRequestError_ImagesDisabled)</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        printf(&quot;Warning: Images disabled. Check your control panel settings.&quot;);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    //Resize image buffer if too small</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    if(image_size &lt; imageErrorEvent-&gt;required_buffer_len){</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        image_size = imageErrorEvent-&gt;required_buffer_len;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        image_buffer = malloc((size_t)image_size);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        printf(&quot;Resized image buffer to %lli.\n&quot;, (long long int)image_size);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    }</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    free(image_token);</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    image_token = NULL;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    imageRequested = false;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;}</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;int main(int argc, char** argv) {</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  //Set callback function pointers</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  ConnectionCallbacks.on_connection          = &amp;OnConnect;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  ConnectionCallbacks.on_device_found        = &amp;OnDevice;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  ConnectionCallbacks.on_frame               = &amp;OnFrame;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  ConnectionCallbacks.on_image_complete      = &amp;OnImages;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  ConnectionCallbacks.on_image_request_error = &amp;OnImageError;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  connection = OpenConnection();</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  printf(&quot;Press Enter to exit program.\n&quot;);</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  getchar();</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  return 0;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;}</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;//End-of-Sample.c</div>
</div><!-- fragment --></p>
<p>Note that this example does not attempt to display image data graphically. See <a class="el" href="a00018.html">Textured Quad Example</a> for an example that uses the GLUT library to create window context for drawing the images. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="a00006.html">Examples</a></li>
    <li class="footer">Generated on Tue Dec 13 2016 15:48:45 for Leap Motion C API by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.10 </li>
  </ul>
</div>
</body>
</html>
